Phase: 6 - Content & Analysis Suite
Part: 6.4
Title: Enterprise Content Strategy Service
Depends On: 6.3-Backend-Content-Generation-Service.md
Objective: To implement the EnterpriseContentStrategyService, an advanced AI-powered service that analyzes existing project data to identify high-impact content gaps, suggest strategic topics, and build a data-driven content roadmap. This service provides the strategic "why" and "what" to our users, perfectly complementing the "how" of the ContentGenerationService.
1. Core Principles: From Data to Strategy
Memory-Driven Insights: The service operates exclusively on the data stored in Project Memory. It will analyze existing keyword data from the CentralRawData bank, competitor information, and performance metrics to find patterns and opportunities.
AI-Powered Analysis: It uses the UnifiedAIService not for generating final content, but for higher-level analysis, such as identifying thematic clusters in competitor keywords or determining the search intent behind a content gap.
Actionable & Prioritized Output: The service doesn't just list data; it delivers a prioritized list of content opportunities, each with a calculated "opportunity score" to help users focus on what matters most.
2. ContentStrategyService Schemas
We need Pydantic schemas to structure the response from this service.
File Location: backend/app/schemas/strategy_schemas.py
File Content:
from pydantic import BaseModel, Field, ConfigDict
from typing import List, Optional

class ContentOpportunity(BaseModel):
    """Represents a single, actionable content opportunity."""
    topic_cluster: str = Field(..., description="The high-level theme or topic for the content.")
    primary_keyword: str
    supporting_keywords: List[str]
    search_intent: str = Field(..., description="e.g., Informational, Commercial, Navigational")
    opportunity_score: int = Field(..., ge=0, le=100, description="A 0-100 score indicating the potential impact.")
    suggested_title: str
    
    model_config = ConfigDict(from_attributes=True)

class ContentStrategyResponse(BaseModel):
    """The full response from a content strategy analysis."""
    project_id: str
    ai_summary: str = Field(..., description="A concise, AI-generated summary of the content strategy.")
    opportunities: List[ContentOpportunity]

3. ContentStrategyService Implementation
This service orchestrates the analysis to produce strategic recommendations.
File Location: backend/app/services/content_strategy_service.py
File Content:
import logging
import asyncio
from sqlalchemy.orm import Session
from typing import Dict, Any, List

from app.services.unified_ai_service import EnterpriseUnifiedAIService
from app.schemas.ai_service_schemas import AITaskRequest, PromptTask
from app.services.project_memory_service import ProjectMemoryService
from app.schemas.strategy_schemas import ContentStrategyResponse, ContentOpportunity
from app.models.central_raw_data import CentralRawData

logger = logging.getLogger(__name__)

STRATEGY_ANALYSIS_COST = 20 # Credit cost for a full content gap analysis

class ContentStrategyService:
    """Analyzes project data to provide strategic content recommendations."""

    def __init__(self, db: Session):
        self.db = db
        self.ai_service = EnterpriseUnifiedAIService(db)
        self.memory_service = ProjectMemoryService(db)

    def analyze_content_gaps(
        self, 
        project_id: str, 
        user_id: str, 
        organization_id: str
    ) -> ContentStrategyResponse:
        """
        Performs a comprehensive content gap analysis for a project.
        """
        # For simplicity, this example assumes the raw data (keywords, etc.) is already
        # stored in the CentralRawData bank from a previous DCS scan.
        # A more complex implementation would fetch it from multiple sources.
        
        project = self.memory_service.get_or_create_project_memory(project_id).project
        
        # 1. Fetch required data from the data bank
        # In a real app, you might fetch competitor data as well
        own_keyword_data = self.db.query(CentralRawData).filter_by(
            domain=project.url, data_type='KEYWORDS_DATAFORSEO'
        ).first()

        if not own_keyword_data or not own_keyword_data.raw_data.get('result'):
            raise ValueError("Insufficient keyword data in Data Bank. Please run a Deep Scan first.")

        # 2. Use AI to analyze the gaps and generate a strategy
        ai_task = AITaskRequest(
            task=PromptTask.ANALYZE_CONTENT_GAPS_V1,
            context={
                "own_keywords": own_keyword_data.raw_data['result'],
                "project_context": {"name": project.name, "url": project.url},
                # Add competitor keywords here for a true gap analysis
            },
            user_id=user_id,
            organization_id=organization_id,
            project_id=project_id,
            estimated_credit_cost=STRATEGY_ANALYSIS_COST
        )
        
        ai_response = self.ai_service.execute_ai_task(ai_task)

        if not ai_response.success or not ai_response.data:
            raise Exception(f"AI strategy analysis failed: {ai_response.error}")

        # 3. Structure the final response using our Pydantic models
        opportunities = [ContentOpportunity(**op) for op in ai_response.data.get('opportunities', [])]
        
        strategy_response = ContentStrategyResponse(
            project_id=project_id,
            ai_summary=ai_response.data.get('ai_summary', 'Analysis complete.'),
            opportunities=opportunities
        )

        logger.info(f"Successfully analyzed content gaps for project {project_id}.")
        return strategy_response

4. Next Steps
The ContentStrategyService is now designed to provide high-level strategic direction. To make its recommendations even more powerful, it needs deeper insights into the keywords it's analyzing.
Next File: 6.5-Backend-Keyword-Analysis-Service.md will create a service to enrich our raw keyword data with semantic clustering and search intent classification, further enhancing the capabilities of both the Strategy and Generation services.