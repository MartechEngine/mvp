Phase: 5 - DCS Engine & Scan Results
Part: 5.3
Title: Enterprise DataForSEO API Client
Depends On: 5.2-External-API-Integration-Overview.md
Objective: To implement a secure, reliable, and production-ready API client for the DataForSEO service. This client inherits from our EnterpriseAPIClient base class, providing built-in resilience patterns, and adds specific methods for fetching SEO data such as backlink summaries and keyword metrics.
1. Core Principle: Specificity and Abstraction
The DataForSEOClient will abstract the specific complexities of the DataForSEO API. It will handle the unique authentication method (HTTP Basic Auth) and translate our internal requests into the precise JSON structures that the DataForSEO API expects. The rest of our application will interact with simple, well-named methods like get_backlink_summary without needing to know the underlying API details.
2. DataForSEOClient Implementation
This class inherits from our base client and implements the necessary methods for DataForSEO.
File Location: backend/app/services/api_clients/dataforseo_client.py
File Content:
import logging
import base64
from typing import Dict, Any, List, Optional

from app.services.api_clients.base_client import EnterpriseAPIClient
from app.core.config import Settings

logger = logging.getLogger(__name__)

class DataForSEOClient(EnterpriseAPIClient):
    """
    An enterprise-grade client for the DataForSEO API.
    Inherits resilience patterns (retries, circuit breaker) from the base class.
    """

    def __init__(self, settings: Settings):
        super().__init__(
            base_url="https://api.dataforseo.com/v3",
            service_name="DataForSEO",
            settings=settings
        )
        self.login = self.settings.DATAFORSEO_LOGIN
        self.password = self.settings.DATAFORSEO_PASSWORD.get_secret_value() if self.settings.DATAFORSEO_PASSWORD else None

        if not self.login or not self.password:
            # This check prevents the client from being instantiated without credentials.
            # The orchestrator should handle this gracefully.
            logger.error("DataForSEO login and password are not configured.")
            raise ValueError("DataForSEO credentials are not configured.")

    def _get_auth_headers(self) -> Dict[str, str]:
        """
        Implements HTTP Basic Auth using credentials from the settings object.
        """
        if not self.login or not self.password:
            return {}
        
        credentials = f"{self.login}:{self.password}"
        encoded_credentials = base64.b64encode(credentials.encode()).decode()
        return {
            "Authorization": f"Basic {encoded_credentials}",
            "Content-Type": "application/json"
        }

    async def get_backlink_summary(self, domain: str) -> Optional[Dict[str, Any]]:
        """
        Fetches a backlink summary for a specific domain.
        The base 'request' method handles retries and circuit breaking.
        """
        payload = [{"target": domain}]
        
        # This call will raise exceptions on failure after all retries are exhausted.
        # The calling service (DCS Orchestrator) is responsible for handling them.
        response_data = await self.request(
            method="POST",
            endpoint="/backlinks/summary/live",
            json_data=payload
        )
        
        # Safely extract the result from the nested structure.
        if response_data and response_data.get("tasks"):
            task = response_data["tasks"][0]
            if task.get("status_code") == 20000 and task.get("result"):
                return task["result"][0]
        
        logger.warning(f"Received unexpected or empty result from DataForSEO for domain {domain}")
        return None

    async def get_keyword_data(self, keywords: List[str], location_code: int = 2840, language_code: str = "en") -> Optional[List[Dict[str, Any]]]:
        """
        Fetches search volume, CPC, and competition data for a list of keywords.
        """
        payload = [{
            "keywords": keywords,
            "location_code": location_code,
            "language_code": language_code
        }]
        
        response_data = await self.request(
            method="POST",
            endpoint="/keywords_data/google/search_volume/live",
            json_data=payload
        )

        if response_data and response_data.get("tasks"):
            task = response_data["tasks"][0]
            if task.get("status_code") == 20000 and task.get("result"):
                return task["result"]
        
        logger.warning(f"Received unexpected or empty result from DataForSEO for keywords: {keywords[:5]}")
        return None

3. Next Steps
We have now built a robust, secure, and resilient client for interacting with the DataForSEO API. The DCS Orchestration Engine (to be built later) will use this client to gather crucial SEO intelligence.
Next File: 5.4-External-Client-Google-PageSpeed.md will follow the exact same pattern. We will create another class, GooglePageSpeedClient, that inherits from our EnterpriseAPIClient and implements the specific authentication and methods required for the Google PageSpeed Insights API.
