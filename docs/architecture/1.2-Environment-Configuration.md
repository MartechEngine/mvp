Phase: 1 - Foundation & Core Infrastructure
Part: 1.2
Title: Enterprise Environment Configuration & Secrets Management
Depends On: 1.1-Project-Skeleton-and-Tooling.md
Objective: To establish a secure, scalable, and type-safe configuration management system using Pydantic for the backend. This file defines how the application will handle everything from database URLs to API keys across different environments (development, staging, production).
1. Backend Pydantic Settings Schema
This Python class uses pydantic-settings to load, validate, and manage all environment variables. It ensures that the application will not start if any critical configuration is missing or invalid.
File Location: backend/app/core/config.py
File Content:
import logging
from typing import List, Optional, Union
from pydantic import AnyHttpUrl, PostgresDsn, RedisDsn, SecretStr, field_validator
from pydantic_settings import BaseSettings, SettingsConfigDict
from enum import Enum

# Configure basic logging for startup
logger = logging.getLogger(__name__)

class Environment(str, Enum):
    """Enumeration for application environments."""
    DEVELOPMENT = "development"
    STAGING = "staging"
    PRODUCTION = "production"
    TESTING = "testing"

class Settings(BaseSettings):
    """
    Enterprise-grade application settings with comprehensive validation.
    Loads variables from a .env file and the environment.
    """
    
    # --- Application Core ---
    ENVIRONMENT: Environment = Environment.DEVELOPMENT
    DEBUG: bool = False
    APP_NAME: str = "MartechEngine"
    API_V1_PREFIX: str = "/api/v1"
    
    # --- Security & JWT ---
    # SECRET_KEY should be a long, random string (e.g., `openssl rand -hex 32`)
    SECRET_KEY: SecretStr
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 60 * 24  # 1 day
    REFRESH_TOKEN_EXPIRE_SECONDS: int = 2592000  # 30 days
    MAX_SESSIONS_PER_USER: int = 10  # Maximum concurrent sessions per user
    
    # --- Cookie Configuration ---
    # ⚠️ For local development (HTTP), COOKIE_SECURE MUST be False.
    # Production/Staging environments should override this to True.
    COOKIE_SECURE: bool = False
    COOKIE_SAMESITE: str = "lax"

    # --- CORS (Cross-Origin Resource Sharing) ---
    CORS_ORIGINS: List[AnyHttpUrl] = []

    @field_validator("CORS_ORIGINS", mode='before')
    @classmethod
    def assemble_cors_origins(cls, v: Union[str, List[str]]) -> Union[List[str], str]:
        if isinstance(v, str) and not v.startswith("["):
            return [i.strip() for i in v.split(",")]
        return v

    # --- Database (PostgreSQL) ---
    DATABASE_URL: PostgresDsn

    # --- Cache & Task Queue (Redis) ---
    REDIS_URL: RedisDsn

    # --- Celery ---
    CELERY_BROKER_URL: RedisDsn
    CELERY_RESULT_BACKEND: RedisDsn

    # --- External APIs (Placeholders) ---
    DATAFORSEO_LOGIN: Optional[str] = None
    DATAFORSEO_PASSWORD: Optional[SecretStr] = None
    GOOGLE_PAGESPEED_API_KEY: Optional[SecretStr] = None
    RAZORPAY_KEY_ID: Optional[str] = None
    RAZORPAY_KEY_SECRET: Optional[SecretStr] = None
    
    # --- Google Cloud Project (Placeholders) ---
    GCP_PROJECT_ID: Optional[str] = None
    VERTEX_AI_LOCATION: Optional[str] = "us-central1"

    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        case_sensitive=True
    )

# Singleton pattern to ensure settings are loaded only once
settings = Settings()

# Log the loaded environment for clarity on startup
logger.info(f"Configuration loaded for ENVIRONMENT: {settings.ENVIRONMENT.value}")
if settings.DEBUG:
    logger.warning("DEBUG mode is enabled. Do not use in production.")

2. Backend Environment File Template (.env.example)
This file serves as a template for all developers. It lists every required environment variable, making local setup straightforward and consistent. This file should be committed to Git.
File Location: backend/.env.example
File Content:

# ===================================================================
# MartechEngine Backend Environment Configuration
# ===================================================================
# Copy this file to .env for local development and fill in the values.
# ⚠️ WARNING: DO NOT commit the .env file to version control.
# ===================================================================

# --- Application Core ---
# Options: development, staging, production, testing
ENVIRONMENT="development"
DEBUG=True

# --- Security & JWT ---
# Generate a secure key with: openssl rand -hex 32
SECRET_KEY="replace_with_your_super_secret_key"
ACCESS_TOKEN_EXPIRE_MINUTES=1440 # 1 day for development
REFRESH_TOKEN_EXPIRE_SECONDS=2592000 # 30 days
MAX_SESSIONS_PER_USER=10 # Maximum concurrent sessions per user

# --- CORS ---
# Comma-separated list of allowed origins for local development
CORS_ORIGINS="http://localhost:3000,http://127.0.0.1:3000"

# --- Cookie Configuration ---
COOKIE_SECURE=False
COOKIE_SAMESITE="lax"

# --- Database (PostgreSQL) ---
# Example for local Docker setup. User, password, and db name must match docker-compose.yml.
DATABASE_URL="postgresql://martech_user:secure_password@localhost:5432/martechengine_dev"

# --- Cache & Task Queue (Redis) ---
# Example for local Docker setup
REDIS_URL="redis://localhost:6379/0"

# --- Celery ---
CELERY_BROKER_URL="redis://localhost:6379/1"
CELERY_RESULT_BACKEND="redis://localhost:6379/2"

# --- External APIs (Optional for initial setup) ---
DATAFORSEO_LOGIN=""
DATAFORSEO_PASSWORD=""
GOOGLE_PAGESPEED_API_KEY=""
RAZORPAY_KEY_ID=""
RAZORPAY_KEY_SECRET=""

# --- Google Cloud Project (Optional for initial setup) ---
GCP_PROJECT_ID=""

3. Frontend Environment File Template
This file provides the necessary configuration for the Next.js frontend application.
File Location: frontend/.env.local.example
File Content:

# ===================================================================
# MartechEngine Frontend Environment Configuration
# ===================================================================
# Copy this file to .env.local for local development.
# ⚠️ WARNING: DO NOT commit the .env.local file.
# ===================================================================

# The base URL of your backend API.
# During local development, this will point to your local FastAPI server.
NEXT_PUBLIC_API_URL="http://localhost:8000"

# Environment identifier
NEXT_PUBLIC_APP_ENV="development"

4. Execution & Integration
Dependency Installation: The developer must run pip install pydantic pydantic-settings in the backend's virtual environment.
Local Setup: Each developer will copy .env.example to .env in the backend directory and .env.local.example to .env.local in the frontend directory, then populate the necessary values (like SECRET_KEY).
Application Startup: The FastAPI application will automatically import the settings object from app.core.config. Pydantic ensures that if any required variable (like SECRET_KEY or DATABASE_URL) is missing, the application will fail to start with a clear error message, preventing misconfiguration.

