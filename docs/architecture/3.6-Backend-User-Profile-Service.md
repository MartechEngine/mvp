Phase: 3 - Core Application & Project Management
Part: 3.6
Title: Backend User Profile Management Service & API
Depends On: 3.5-Frontend-Project-Dashboard-UI.md
Objective: To implement the backend components for comprehensive user profile management. This includes a secure UserProfileService for handling business logic and the corresponding FastAPI endpoints for updating profiles and changing passwords.
1. Core Principle: Security and Validation First
All profile management operations, especially password changes, are security-sensitive. This implementation prioritizes:
Ownership Verification: Ensuring users can only modify their own data via the get_current_active_user dependency.
Credential Validation: Requiring the current password for sensitive actions like changing a password.
Strong Validation: Using Pydantic schemas to enforce strong password policies and validate all incoming data.
2. User Profile Pydantic Schemas
We'll define the schemas for updating user profiles and changing passwords in our existing user_schemas.py file.
File to Modify: backend/app/schemas/user_schemas.py
Content to Add:
# Add these imports at the top
import re
from pydantic import field_validator

# ... (existing user schemas) ...

# --- New Request Schemas for Profile Management ---

class UserProfileUpdate(BaseModel):
    """Schema for updating a user's public profile information."""
    full_name: Optional[str] = Field(None, min_length=2, max_length=100)

class PasswordUpdate(BaseModel):
    """Schema for a password change request."""
    current_password: str
    new_password: str = Field(..., min_length=8, description="Password must be at least 8 characters.")

    @field_validator('new_password')
    @classmethod
    def validate_password_strength(cls, v: str) -> str:
        """Validate password meets security requirements."""
        if not re.search(r'[A-Z]', v):
            raise ValueError('Password must contain at least one uppercase letter')
        if not re.search(r'[a-z]', v):
            raise ValueError('Password must contain at least one lowercase letter')
        if not re.search(r'\d', v):
            raise ValueError('Password must contain at least one digit')
        # Example for special character: add more as needed
        if not re.search(r'[!@#$%^&*(),.?":{}|<>]', v):
            raise ValueError('Password must contain at least one special character')
        return v
3. User Profile Service
This service encapsulates the business logic for all profile and account management actions.
File Location: backend/app/services/user_profile_service.py
File Content:
import logging
from sqlalchemy.orm import Session

from app.core.security import get_password_hash, verify_password
from app.models.user import User
from app.schemas.user_schemas import UserProfileUpdate, PasswordUpdate

logger = logging.getLogger(__name__)

class UserProfileService:
    """Service layer for user profile and account management."""

    def __init__(self, db: Session):
        self.db = db

    def update_profile(self, *, user: User, profile_update: UserProfileUpdate) -> User:
        """
        Updates a user's profile information.
        """
        update_data = profile_update.model_dump(exclude_unset=True)
        
        if "full_name" in update_data and update_data["full_name"]:
            user.full_name = update_data["full_name"]
            
        self.db.add(user)
        self.db.commit()
        self.db.refresh(user)
        logger.info(f"User profile for {user.email} updated.")
        return user

    def change_password(self, *, user: User, password_update: PasswordUpdate):
        """
        Changes a user's password after verifying their current password.
        Raises ValueError on failure.
        """
        if not verify_password(password_update.current_password, user.hashed_password):
            logger.warning(f"Incorrect password attempt for user {user.email}.")
            raise ValueError("The current password you entered is incorrect.")
            
        if verify_password(password_update.new_password, user.hashed_password):
            raise ValueError("The new password cannot be the same as your current password.")

        user.hashed_password = get_password_hash(password_update.new_password)
        self.db.add(user)
        self.db.commit()
        
        logger.info(f"Password changed for user {user.email}.")
        # In a real app, you would also invalidate all other user sessions/refresh tokens here.

4. User Profile API Endpoints
This router provides the API endpoints for the frontend to call for profile management.
File to Modify: backend/app/api/v1/endpoints/users.py
File Content:
import logging
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from typing import Any

from app.core.database import get_db
from app.api.v1.dependencies.auth_deps import get_current_active_user
from app.services.user_profile_service import UserProfileService
from app.schemas.user_schemas import UserProfileUpdate, PasswordUpdate, User as UserSchema
from app.schemas.common_schemas import APISuccessResponse
from app.models.user import User as UserModel

logger = logging.getLogger(__name__)
router = APIRouter()

@router.get(
    "/me",
    response_model=APISuccessResponse[UserSchema],
    summary="Get current user's profile"
)
def get_current_user_profile(
    current_user: UserModel = Depends(get_current_active_user)
) -> Any:
    """
    Retrieves the profile for the currently authenticated user.
    """
    return APISuccessResponse(data=current_user)

@router.put(
    "/me",
    response_model=APISuccessResponse[UserSchema],
    summary="Update current user's profile"
)
def update_current_user_profile(
    profile_in: UserProfileUpdate,
    db: Session = Depends(get_db),
    current_user: UserModel = Depends(get_current_active_user)
) -> Any:
    """
    Updates the profile information (e.g., full_name) for the authenticated user.
    """
    profile_service = UserProfileService(db)
    updated_user = profile_service.update_profile(user=current_user, profile_update=profile_in)
    return APISuccessResponse(data=updated_user, message="Profile updated successfully.")

@router.put(
    "/me/password",
    status_code=status.HTTP_204_NO_CONTENT,
    summary="Change current user's password"
)
def change_current_user_password(
    password_in: PasswordUpdate,
    db: Session = Depends(get_db),
    current_user: UserModel = Depends(get_current_active_user)
):
    """
    Changes the password for the authenticated user.
    """
    profile_service = UserProfileService(db)
    try:
        profile_service.change_password(user=current_user, password_update=password_in)
    except ValueError as e:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=str(e),
        )

5. Next Steps
We have now built the complete backend functionality for a user to manage their own profile. The API is secure, follows best practices, and is ready for the frontend to consume.
Next File: 3.7-Frontend-User-Profile-UI.md will create the corresponding React Query hooks (useUpdateProfile, useChangePassword) and the user interface components for the "Account Settings" page.