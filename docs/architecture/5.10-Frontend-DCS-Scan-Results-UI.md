Phase: 5 - DCS Engine & Scan Results
Part: 5.10
Title: Frontend DCS Scan Results UI
Depends On: 5.9-Backend-Real-Time-Progress-API.md
Objective: To design the robust, efficient, and user-friendly UI for the unified DCS Scan Results Page. This page is the central hub where users view their scores, all collected scan data, and the actionable Content Generation CTAs that are the core value proposition of a scan.
1. Core Principle: The Unified Results Hub
This component directly implements the product vision from chunk-6-dcs-scan-results-ui-ux.md. It rejects the fragmented approach of separate pages for keywords, site audit, etc., in favor of a single, powerful dashboard that provides a complete overview of the scan's findings in one place.
2. New Custom Hooks for Scan Results
We need a new set of hooks to fetch the scan results and stream progress updates.
File Location: frontend/src/hooks/useDCSScan.ts
File Content:
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useEffect, useState } from 'react';
import { toast } from 'react-hot-toast';

import { apiClient } from '@/lib/api/client';
// Assume new types are created in `frontend/src/types/dcs.ts`
import { DCSScanResult, InitiateScanPayload, InitiateScanResponse, ScanProgress } from '@/types/dcs';

// --- Query Key Factory ---
export const dcsScanKeys = {
  all: ['dcsScans'] as const,
  resultsByAudit: (auditId: string) => [...dcsScanKeys.all, 'detail', auditId] as const,
};

// --- Service Layer ---
class DCSScanService {
  static async initiateScan(payload: InitiateScanPayload): Promise<InitiateScanResponse> {
    const response = await apiClient.post(`/dcs/scans/${payload.project_id}`, null, { params: { scan_type: payload.scan_type } });
    return response.data;
  }
  static async getScanResult(auditId: string): Promise<DCSScanResult> {
    const response = await apiClient.get(`/dcs/scan-results/${auditId}`);
    return response.data.data;
  }
}

// --- Hooks ---
export const useInitiateDCSScan = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: DCSScanService.initiateScan,
    onSuccess: () => {
      // Invalidate queries that might show scan history to reflect the new "pending" scan
      queryClient.invalidateQueries({ queryKey: ['scanHistory'] }); // Placeholder key
    },
    onError: (error: Error) => toast.error(`Failed to start scan: ${error.message}`),
  });
};

export const useDCSScanResult = (auditId: string | null) => {
  return useQuery({
    queryKey: dcsScanKeys.resultsByAudit(auditId!),
    queryFn: () => DCSScanService.getScanResult(auditId!),
    enabled: !!auditId,
  });
};

export const useDCSScanProgress = (auditId: string | null) => {
  const [progress, setProgress] = useState<ScanProgress | null>(null);
  const queryClient = useQueryClient();

  useEffect(() => {
    if (!auditId) return;

    const eventSource = new EventSource(
      `${process.env.NEXT_PUBLIC_API_URL}/dcs/scans/${auditId}/stream`
    );

    eventSource.onopen = () => {
      setProgress({ progress: 5, message: 'Connection established...', is_final: false });
    };

    eventSource.addEventListener('progress_update', (event) => {
      const data = JSON.parse(event.data);
      setProgress(data);
      if (data.is_final) {
        toast.success('Scan complete! Fetching final results.');
        queryClient.invalidateQueries({ queryKey: dcsScanKeys.resultsByAudit(auditId) });
        eventSource.close();
      }
    });

    eventSource.onerror = () => {
      toast.error('Real-time connection to the server was lost.');
      eventSource.close();
    };

    return () => {
      eventSource.close();
    };
  }, [auditId, queryClient]);

  return progress;
};
3. Scan Results Page UI
This page will be located at a new route, e.g., /projects/{projectId}/scans/{auditId}.
File Location: frontend/src/app/(dashboard)/projects/[projectId]/scans/[auditId]/page.tsx
File Content:
"use client";

import { useParams } from 'next/navigation';
import { useDCSScanResult, useDCSScanProgress } from '@/hooks/useDCSScan';
import { ScoresSection } from '@/components/features/scan-results/ScoresSection';
import { DataCardsSection } from '@/components/features/scan-results/DataCardsSection';
import { CTASection } from '@/components/features/scan-results/CTASection';
import { Progress } from '@/components/ui/progress';

export default function ScanResultPage() {
  const params = useParams();
  const auditId = params.auditId as string;

  const { data: scanResult, isLoading, isError } = useDCSScanResult(auditId);
  const progress = useDCSScanProgress(scanResult ? null : auditId); // Only stream if results aren't loaded yet

  // Show progress bar if a scan is running and we don't have the final results yet
  if (progress && !scanResult) {
    return (
      <div className="flex flex-col items-center justify-center h-full">
        <div className="w-full max-w-md space-y-4">
          <h2 className="text-2xl font-semibold text-center">Scan in Progress</h2>
          <Progress value={progress.progress} className="w-full" />
          <p className="text-center text-muted-foreground">{progress.message}</p>
        </div>
      </div>
    );
  }

  if (isLoading) return <div>Loading scan results...</div>;
  if (isError) return <div>Error loading scan results.</div>;

  return (
    <div className="max-w-7xl mx-auto space-y-8">
      <ScoresSection scores={scanResult.scores} />
      <DataCardsSection data={scanResult.data} />
      <CTASection ctas={scanResult.ctas} />
    </div>
  );
}

// --- Placeholder Components for Structure ---
// These would be built out in their own files in `/components/features/scan-results/`
const ScoresSection = ({ scores }) => (
  <Card><CardHeader><CardTitle>Scores Section</CardTitle></CardHeader><CardContent><pre>{JSON.stringify(scores, null, 2)}</pre></CardContent></Card>
);
const DataCardsSection = ({ data }) => (
  <Card><CardHeader><CardTitle>Data Cards Section</CardTitle></CardHeader><CardContent><pre>{JSON.stringify(data, null, 2)}</pre></CardContent></Card>
);
const CTASection = ({ ctas }) => (
  <Card><CardHeader><CardTitle>Content Generation CTAs</CardTitle></CardHeader><CardContent><pre>{JSON.stringify(ctas, null, 2)}</pre></CardContent></Card>
);

4. Sitemap Update
The sitemap needs to be updated to reflect this new, unified results page.
File to Modify: 1.5.1-Frontend-Sitemap-and-Views.md
Content to Change:
REMOVE the separate pages: /projects/{projectId}/site-audit, /projects/{projectId}/keywords, /projects/{projectId}/competitors.
ADD a new page:
/projects/{projectId}/scans/{auditId}:
Purpose: The single, unified dashboard to view all results and actionable CTAs from a specific DCS scan.
Sidebar Menu: A new top-level menu item Scan History could link to a list of scans, and from there to this page.
5. Conclusion of Phase 5
This file concludes the design for the core DCS feature loop. We have now architected:
A robust, asynchronous backend engine for running complex scans with resilient fallbacks.
Normalized, structured data models for storing all collected and generated intelligence.
A real-time API for pushing live progress updates to the user.
A unified, user-friendly frontend for initiating scans and viewing the comprehensive results.
Next File: 5.11-Suite-Overview.md