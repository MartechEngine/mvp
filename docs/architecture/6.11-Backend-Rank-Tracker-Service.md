# Phase: 6 - Content & Analysis Suite
# Part: 6.11
# Title: Backend Rank Tracker Service
# Depends On: 5.11-Suite-Overview.md

**Objective:** To design and specify the backend architecture for a **Keyword Rank Tracker** service. This service will allow users to add specific keywords to a project for monitoring, and it will periodically fetch and store the project's search engine ranking for those keywords over time.

### 1. Core Principles

*   **Historical Data:** The primary goal is to store historical ranking data to visualize trends. Every rank check must be stored as a new, timestamped record.
*   **Scheduled & On-Demand:** Rank checks will be performed automatically on a recurring basis (e.g., daily) via a scheduled task. The system should also support on-demand checks initiated by the user, subject to credit consumption.
*   **Data Source:** The service will use a third-party data provider (e.g., DataForSEO) as the source for SERP (Search Engine Results Page) data.
*   **Credit-Aware:** On-demand rank checks will consume AI credits. The cost will be per keyword checked.

### 2. Data Model

Two new models are required, linked to the `Project` model.

**`TrackedKeyword` Model:** Represents a keyword that a user has chosen to monitor for a specific project.

```sql
CREATE TABLE tracked_keywords (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    keyword TEXT NOT NULL,
    target_location TEXT, -- e.g., 'US', 'GB'
    target_language TEXT, -- e.g., 'en', 'es'
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    is_active BOOLEAN NOT NULL DEFAULT TRUE, -- To allow users to pause tracking
    UNIQUE (project_id, keyword, target_location, target_language)
);
```

**`RankHistory` Model:** An append-only table to store the results of every rank check.

```sql
CREATE TABLE rank_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tracked_keyword_id UUID NOT NULL REFERENCES tracked_keywords(id) ON DELETE CASCADE,
    check_date DATE NOT NULL,
    rank INTEGER, -- The ranking position. NULL if not found in top 100.
    page_url TEXT, -- The URL of the page that is ranking.
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

### 3. Service Layer: `RankTrackerService`

This service encapsulates all business logic for the rank tracker.

*   **`add_keyword_to_project(project_id, keyword_payload)`**: Creates a new `TrackedKeyword` record. Checks if the organization's plan allows for more tracked keywords.
*   **`list_tracked_keywords(project_id)`**: Returns all tracked keywords for a project, along with their most recent rank from the `RankHistory` table.
*   **`get_keyword_history(tracked_keyword_id)`**: Returns the full time-series data (date, rank) for a single keyword.
*   **`trigger_on_demand_check(user, tracked_keyword_id)`**: The core logic for an on-demand check.
    1.  Calls `CreditService` to reserve credits.
    2.  Enqueues a Celery task `run_single_keyword_rank_check`.
    3.  Returns the task ID to the user.

### 4. Asynchronous Task (Celery)

*   **`run_daily_rank_checks()` (Scheduled Task - Celery Beat):**
    1.  Queries for all `is_active=True` `TrackedKeyword` records across all projects.
    2.  For each keyword, enqueues a `run_single_keyword_rank_check` task.
*   **`run_single_keyword_rank_check(tracked_keyword_id)` (Executor Task):**
    1.  Takes a `tracked_keyword_id`.
    2.  Calls the external data provider (e.g., DataForSEO) with the keyword, domain, location, and language.
    3.  Parses the response to find the rank and the ranking URL.
    4.  Creates a new `RankHistory` record with the result.
    5.  If it was an on-demand check (i.e., a `ledger_id` was passed), it calls `CreditService.consume_reservation()`.

### 5. API Layer (`/api/v1/projects/{project_id}/tracker`)

A new FastAPI router to expose the service.

*   **`POST /`**: Add a new keyword to track.
    *   Body: `{ "keyword": "best seo tools", "location": "US" }`
    *   Calls `RankTrackerService.add_keyword_to_project()`.
*   **`GET /`**: List all tracked keywords for the project.
    *   Calls `RankTrackerService.list_tracked_keywords()`.
*   **`GET /{tracked_keyword_id}/history`**: Get the historical rank data for a single keyword.
    *   Calls `RankTrackerService.get_keyword_history()`.
*   **`POST /{tracked_keyword_id}/refresh`**: Trigger an on-demand rank check for a single keyword.
    *   Calls `RankTrackerService.trigger_on_demand_check()`.
    *   Returns a `202 Accepted` with the task ID.
