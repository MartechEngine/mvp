Phase: 1 - Foundation & Core Infrastructure
Part: 1.7
Title: Backend Application Initialization
Depends On: 1.6-Frontend-Setup-React-Query.md
Objective: To initialize the FastAPI application with production-ready configurations, including security middleware, structured logging, comprehensive error handling, and a health check endpoint. This creates a robust backend foundation.
1. Gunicorn Configuration (Production Web Server)
Gunicorn will serve as our production WSGI server, managing multiple Uvicorn workers for performance and reliability.
File Location: backend/gunicorn_conf.py (New File in backend root)
File Content:
import os

# Gunicorn configuration file

# Server socket
# Use PORT environment variable if available, otherwise default to 8000
bind = f"0.0.0.0:{os.getenv('PORT', '8000')}"

# Worker processes
# Use WEB_CONCURRENCY if set, otherwise default to a sensible value (e.g., 2)
workers = int(os.getenv('WEB_CONCURRENCY', 2))
worker_class = "uvicorn.workers.UvicornWorker"

# Logging
# Set log level from environment or default to 'info'
loglevel = os.getenv('GUNICORN_LOG_LEVEL', 'info')
accesslog = "-"  # Log access logs to stdout
errorlog = "-"   # Log error logs to stderr

# Performance
timeout = int(os.getenv('GUNICORN_TIMEOUT', 120))
keepalive = int(os.getenv('GUNICORN_KEEPALIVE', 5))

# For reloading in development if needed, though uvicorn --reload is preferred
reload = bool(os.getenv('GUNICORN_RELOAD', False))
2. Main Application Entrypoint (main.py)
This is the core of the backend application. It initializes FastAPI, sets up middleware, defines a global error handler, and includes a root and health check endpoint.
File Location: backend/app/main.py
File Content:```python
import logging
import time
import uuid
from fastapi import FastAPI, Request, Depends
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from sqlalchemy.orm import Session

from app.core.config import settings
from app.core.database import get_db
Initialize FastAPI app
app = FastAPI(
title=settings.APP_NAME,
description="The backend for the AI-Powered MartechEngine.",
version="1.0.0",
# Hide OpenAPI docs in production for security
docs_url=f"{settings.API_V1_PREFIX}/docs" if settings.DEBUG else None,
redoc_url=f"{settings.API_V1_PREFIX}/redoc" if settings.DEBUG else None,
)
--- Middleware ---
CORS Middleware
This allows the frontend (running on localhost:3000) to communicate with the backend (localhost:8000)
if settings.CORS_ORIGINS:
app.add_middleware(
CORSMiddleware,
allow_origins=[str(origin) for origin in settings.CORS_ORIGINS],
allow_credentials=True,
allow_methods=[""],
allow_headers=[""],
)
Request Context & Timing Middleware
@app.middleware("http")
async def request_context_middleware(request: Request, call_next):
"""
Adds a unique request ID and process time to every request for improved logging and tracing.
"""
request_id = str(uuid.uuid4())
start_time = time.time()
response = await call_next(request)

process_time = (time.time() - start_time) * 1000
response.headers["X-Process-Time-MS"] = f"{process_time:.2f}"
response.headers["X-Request-ID"] = request_id

return response
--- Global Exception Handler ---
@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
"""
Handles any unhandled exceptions in the application, preventing crashes and returning a generic error.
"""
request_id = request.headers.get("X-Request-ID", "N/A")
logging.error(f"Unhandled exception for request {request_id}: {exc}", exc_info=True)
return JSONResponse(
status_code=500,
content={
"detail": "An internal server error occurred.",
"request_id": request_id
},
)
--- Root & Health Check Endpoints ---
@app.get("/", tags=["Root"])
async def read_root():
"""
Root endpoint providing basic application info.
"""
return {
"message": f"Welcome to the {settings.APP_NAME} API",
"environment": settings.ENVIRONMENT,
"debug_mode": settings.DEBUG
}
@app.get("/health", tags=["Health"])
async def health_check():
"""
Simple health check endpoint to verify that the service is running.
A database check will be added here in a later phase.
"""
return {"status": "healthy"}
--- API Routers (to be added in later phases) ---
# Note: This import will be uncommented when the API router is implemented in Phase 2
# from app.api.v1 import api_router
# app.include_router(api_router, prefix=settings.API_V1_PREFIX)
logging.info("FastAPI application initialized.")

### **3. Execution & Integration**

*   **Running Locally:** With this file, a developer can now run `docker-compose up`. They should see the backend start successfully and be able to navigate to `http://localhost:8000/` to see the welcome message and `http://localhost:8000/health` to see the healthy status.
*   **Production Command:** The `CMD` in the `backend/Dockerfile` is now configured to use Gunicorn, our production server, which will read the `gunicorn_conf.py` file for its settings when deployed.
*   **Structured Logging:** A dedicated structured logging configuration (`logging_conf.py`) will be added in a later phase to enhance our observability, but the basic functionality is now in place.
