Phase: 2 - User Identity & Authentication
Part: 2.10.2
Title: Frontend Email Verification UI
Depends On: 2.10-Frontend-Auth-UI-Forms.md
Objective: To design and implement the frontend UI components required for a complete email verification flow. This includes a page to process the verification link from the user's email and UI prompts for unverified users who try to log in.

2. Email Verification Page
This is the page the user lands on after clicking the verification link in their email. It extracts the token from the URL, calls the verification API, and displays the result.
File Location: frontend/src/app/auth/verify-email/page.tsx
File Content:
'use client';

import { useEffect, Suspense } from 'react';
import { useSearchParams } from 'next/navigation';
import { useMutation } from '@tanstack/react-query';
import { toast } from 'react-hot-toast';
import Link from 'next/link';
import { CheckCircle, XCircle, Loader2 } from 'lucide-react';
import { apiClient } from '@/lib/api/client';

// This service method calls the correct verification endpoint
const verifyEmail = async (token: string): Promise<{ message: string }> => {
  // This now points to the correct backend endpoint defined in 2.6.2
  const response = await apiClient.get(`/email-verification/verify?token=${token}`);
  return response.data;
};

function VerifyEmailComponent() {
  const searchParams = useSearchParams();
  const token = searchParams.get('token');

  const { mutate, isPending, isSuccess, isError, error } = useMutation({
    mutationFn: (token: string) => verifyEmail(token),
    onSuccess: (data) => {
      toast.success(data.message || 'Your email has been verified successfully!');
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Verification failed. The link may be invalid or expired.');
    },
  });

  useEffect(() => {
    if (token) {
      mutate(token);
    }
  }, [token, mutate]);

  if (!token) {
    return (
      <div className="text-center">
        <XCircle className="mx-auto h-12 w-12 text-red-500" />
        <h2 className="mt-4 text-2xl font-bold">Invalid Verification Link</h2>
        <p className="mt-2 text-muted-foreground">This link is missing the required token. Please try again.</p>
      </div>
    );
  }

  if (isPending) {
    return (
      <div className="text-center">
        <Loader2 className="mx-auto h-12 w-12 animate-spin text-primary" />
        <h2 className="mt-4 text-2xl font-bold">Verifying your email...</h2>
        <p className="mt-2 text-muted-foreground">Please wait a moment.</p>
      </div>
    );
  }

  return (
    <div className="text-center">
      {isSuccess && (
        <>
          <CheckCircle className="mx-auto h-12 w-12 text-green-500" />
          <h2 className="mt-4 text-2xl font-bold">Verification Successful!</h2>
          <p className="mt-2 text-muted-foreground">You can now log in to your account.</p>
          <Button asChild className="mt-6">
            <Link href="/login">Go to Login</Link>
          </Button>
        </>
      )}
      {isError && (
        <>
          <XCircle className="mx-auto h-12 w-12 text-red-500" />
          <h2 className="mt-4 text-2xl font-bold">Verification Failed</h2>
          <p className="mt-2 text-muted-foreground">{error?.message || 'The link may be invalid or expired.'}</p>
          {/* Optionally, add a button here to resend the verification email */}
        </>
      )}
    </div>
  );
}

// Use Suspense to handle client-side rendering of searchParams
export default function VerifyEmailPage() {
  return (
    <div className="flex min-h-screen items-center justify-center p-4">
      <Suspense fallback={<div>Loading...</div>}>
        <VerifyEmailComponent />
      </Suspense>
    </div>
  );
}
3. UI for Unverified Users
When a user tries to log in but their account is not verified, the API should return a specific error code. We'll use this to display a targeted message on the login page.
File Location: frontend/src/app/(auth)/login/page.tsx (Modification)
Key Change: The onError handler in the useLogin mutation will now check for a specific error code related to unverified users and show a "Resend Verification" button.
// In frontend/src/app/(auth)/login/page.tsx

// ... imports
import { useState } from 'react';
import { AuthService } from '@/services/auth.service'; // Add resend method here

export default function LoginPage() {
  const [showResendVerification, setShowResendVerification] = useState(false);
  
  // ... (form setup) ...
  
  const { mutate: login, isPending: isLoginLoading } = useLogin({
    onError: (error: Error) => {
      // The backend should return a specific message or code for this case.
      if (error.message.includes('verify your email')) {
        toast.error('Please verify your email before logging in.');
        setShowResendVerification(true);
      } else {
        toast.error(error.message);
        setShowResendVerification(false);
      }
    },
  });

  const { mutate: resendVerification, isPending: isResendLoading } = useMutation({
      // This service method should call `POST /email-verification/resend` with the email in the body.
      mutationFn: (email: string) => AuthService.resendVerificationEmail(email), 
      onSuccess: () => toast.success('A new verification email has been sent.'),
      onError: (error: Error) => toast.error(error.message),
  });

  const handleResend = () => {
      const email = form.getValues('email');
      if (email) {
          resendVerification(email);
      } else {
          toast.error('Please enter your email address first.');
      }
  };
  
  // ... (onSubmit function) ...

  return (
    <div className="flex min-h-screen items-center justify-center ...">
      <Card className="...">
        {/* ... CardHeader and CardContent with form ... */}
        {showResendVerification && (
            <div className="mt-4 text-center">
                <p className="text-sm text-muted-foreground">Didn't receive a link?</p>
                <Button variant="link" onClick={handleResend} disabled={isResendLoading}>
                    {isResendLoading ? 'Sending...' : 'Resend Verification Email'}
                </Button>
            </div>
        )}
      </Card>
    </div>
  );
}
4. Next Steps
With the full authentication and verification flow now designed, the next logical step is to build the application's "shell"â€”the persistent header and sidebar that authenticated users will see.
Next File: 2.10.3-Frontend-App-Shell-UI.md will implement the main application layout, including the global Header and the project-centric Sidebar.
